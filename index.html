<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoStuffy - Stuffed Animal Capture Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    /* Basic Reset & Layout */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    /* Map occupies 70% of the viewport height */
    #map { height: 70vh; width: 100%; }
    
    /* Capture Overlay (full screen) */
    #captureOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }
    #captureContent {
      background: #222;
      padding: 20px;
      border: 2px solid #fff;
      border-radius: 8px;
      text-align: center;
      max-width: 90%;
    }
    #rollDisplay {
      font-size: 3em;
      margin: 20px 0;
      min-height: 60px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: #fff;
    }
    #closeCapture { background-color: #f44336; }
    
    /* Collection Display */
    #collection {
      padding: 10px;
      background: #fff;
      border-top: 2px solid #ccc;
      text-align: center;
    }
    #collection h2 { margin-top: 0; }
    .stuffy-img {
      width: 50px;
      height: auto;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    
    /* Player Marker – Blinking Circle (10×10px) */
    .blinking-circle {
      width: 10px;
      height: 10px;
      background: rgba(0,0,255,0.6);
      border: 1px solid white;
      border-radius: 50%;
      box-shadow: 0 0 3px 1px rgba(0,0,255,0.5);
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.2; }
      100% { opacity: 1; }
    }
    
    /* Home Base Icon (House) */
    .home-icon {
      background: url('house.png') no-repeat center center;
      background-size: contain;
      width: 20px;
      height: 20px;
    }
    
    /* Stuffed Animal Marker – Show Image & Rarity Dot */
    .stuffy-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: auto;
    }
    .stuffy-image {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: block;
    }
    .rarity-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .normal { background-color: gray; }
    .rare { background-color: blue; }
    .epic { background-color: purple; }
    .legendary { background-color: gold; animation: glow 1.5s infinite alternate; }
    @keyframes glow {
      0% { box-shadow: 0 0 5px gold; }
      100% { box-shadow: 0 0 15px gold; }
    }
    
    /* Interaction Circle styling */
    .interaction-circle {
      stroke: blue;
      fill: blue;
      fill-opacity: 0.2;
    }
  </style>
</head>
<body>
  <!-- Map Container -->
  <div id="map"></div>
  
  <!-- Capture Overlay -->
  <div id="captureOverlay">
    <div id="captureContent">
      <h2 id="stuffyName">Stuffy</h2>
      <p id="stuffyDescription">A cute stuffed animal waiting to be captured!</p>
      <img id="stuffyImage" src="" alt="Stuffy" style="width:150px; margin-bottom:20px;">
      <div id="rollDisplay">--</div>
      <button id="rollCaptureBtn">Roll Capture</button>
      <button id="closeCapture">Cancel</button>
      <p id="captureResult"></p>
    </div>
  </div>
  
  <!-- Collection Display -->
  <div id="collection">
    <h2>Your Collection</h2>
    <div id="collectionDisplay">No stuffed animals captured yet.</div>
    <button onclick="transferToHome()">Transfer to Home</button>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /***** GLOBAL VARIABLES *****/
    let homeLocation = null; // Home base location
    let capturedStuffies = []; // Currently captured stuffies (not yet transferred)
    const captureThresholds = {
      normal: 70,
      rare: 50,
      epic: 30,
      legendary: 10
    };
    const rarityLevels = {
      normal: { chance: 60, name: "Cuddly Stuffy", successRate: captureThresholds.normal, cssClass: "normal" },
      rare: { chance: 25, name: "Mystic Stuffy", successRate: captureThresholds.rare, cssClass: "rare" },
      epic: { chance: 10, name: "Ethereal Stuffy", successRate: captureThresholds.epic, cssClass: "epic" },
      legendary: { chance: 5, name: "Celestial Stuffy", successRate: captureThresholds.legendary, cssClass: "legendary" }
    };
    
    // For image selection, assume images are named Subject.png, Subject2.png, ... Subject50.png
    function getRandomImage(index) {
      // For diversity, you could randomize index or cycle through
      let num = (index % 50) + 1;
      return `Subject${num}.png`;
    }
    
    /***** MAP & GEOPOSITIONING SETUP *****/
    // Default values (fallback)
    let defaultLat = 51.505, defaultLng = -0.09;
    let map = L.map('map').setView([defaultLat, defaultLng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    
    // Player Marker (blinking circle)
    let playerIcon = L.divIcon({
      className: '',
      html: '<div class="blinking-circle"></div>',
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });
    let playerMarker = L.marker([defaultLat, defaultLng], {icon: playerIcon}).addTo(map);
    
    // Interaction Circle (230 m ≈ 250 yards)
    let interactionRadius = 230;
    let interactionCircle = L.circle(playerMarker.getLatLng(), {
      radius: interactionRadius,
      className: 'interaction-circle'
    }).addTo(map);
    
    // Update player position using geolocation
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(function(position) {
        let lat = position.coords.latitude;
        let lng = position.coords.longitude;
        let newLatLng = [lat, lng];
        playerMarker.setLatLng(newLatLng);
        interactionCircle.setLatLng(newLatLng);
      }, function(error) {
        console.error("Geolocation error: " + error.message);
      }, {enableHighAccuracy: true, maximumAge: 3000, timeout: 5000});
    }
    
    /***** HOME BASE SETUP *****/
    // Set home base to the player's first location
    navigator.geolocation.getCurrentPosition(function(position) {
      let lat = position.coords.latitude;
      let lng = position.coords.longitude;
      map.setView([lat, lng], 15);
      playerMarker.setLatLng([lat, lng]);
      interactionCircle.setLatLng([lat, lng]);
      setHomeLocation(lat, lng);
      spawnStuffies(lat, lng);
    }, function(error) {
      console.error("Error getting initial position: " + error.message);
      spawnStuffies(defaultLat, defaultLng);
    });
    
    function setHomeLocation(lat, lng) {
      homeLocation = { lat, lng };
      // Add a house icon at home base (ensure house.png is in your repository)
      L.marker([lat, lng], { 
        icon: L.divIcon({
          className: 'home-icon',
          html: '<div class="home-icon"></div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map).bindPopup("Home Base");
    }
    
    /***** SPAWNING STUFFIES *****/
    // We want to ensure 2-4 stuffies every couple hundred yards.
    // For a 5-mile radius, we'll spawn a good number; here we'll spawn 150 total.
    function spawnStuffies(playerLat, playerLng) {
      // We'll spawn 150 stuffies within a 5-mile radius.
      let radiusMiles = 5;
      for (let i = 0; i < 150; i++) {
        let rarity = assignRarity();
        let point = randomPointNearRoads(playerLat, playerLng, radiusMiles);
        let stuffy = {
          id: `stuffy_${i}`,
          name: `${rarity.name} #${i+1}`,
          rarity: rarity,
          lat: point.lat,
          lng: point.lng,
          image: getRandomImage(i)
        };
        createStuffyMarker(stuffy);
      }
    }
    
    function assignRarity() {
      let roll = Math.random() * 100;
      let cumulative = 0;
      for (let key in rarityLevels) {
        cumulative += rarityLevels[key].chance;
        if (roll <= cumulative) return rarityLevels[key];
      }
      return rarityLevels.normal;
    }
    
    // For simplicity, we simulate "near roads" by randomly generating points within the radius.
    function randomPointNearRoads(lat, lng, radiusMiles) {
      let degreesPerMile = 1 / 69;
      let r = radiusMiles * degreesPerMile * Math.sqrt(Math.random());
      let theta = Math.random() * 2 * Math.PI;
      let newLat = lat + r * Math.cos(theta);
      let newLng = lng + r * Math.sin(theta) / Math.cos(lat * Math.PI/180);
      return { lat: newLat, lng: newLng };
    }
    
    // Create a marker on the map for the stuffy that displays its image and rarity dot.
    function createStuffyMarker(stuffy) {
      // Create a div element to represent the marker.
      let markerDiv = document.createElement("div");
      markerDiv.className = "stuffy-marker";
      markerDiv.style.position = "absolute";
      // Use Leaflet's map.latLngToLayerPoint to position the marker; we'll update positions on map move.
      let latLng = L.latLng(stuffy.lat, stuffy.lng);
      let point = map.latLngToLayerPoint(latLng);
      markerDiv.style.left = point.x + "px";
      markerDiv.style.top = point.y + "px";
      
      // Create an image element for the stuffy.
      let img = document.createElement("img");
      img.src = stuffy.image;
      img.alt = stuffy.name;
      img.className = "stuffy-image";
      markerDiv.appendChild(img);
      
      // Create the rarity dot.
      let dot = document.createElement("div");
      dot.className = "rarity-dot " + stuffy.rarity.cssClass;
      markerDiv.appendChild(dot);
      
      // When clicked, attempt to capture.
      markerDiv.onclick = function() {
        let playerPos = playerMarker.getLatLng();
        let markerLatLng = L.latLng(stuffy.lat, stuffy.lng);
        let distance = playerPos.distanceTo(markerLatLng);
        console.log("Distance:", distance);
        if (distance <= interactionRadius * 1.1) {
          startCapture(stuffy, markerDiv);
        } else {
          alert("That stuffed animal is out of range. Move closer to capture it.");
        }
      };
      
      // Add the markerDiv to a custom overlay pane so that it stays on top of the map.
      let pane = map.getPanes().overlayPane;
      pane.appendChild(markerDiv);
      
      // Update the marker position on map move.
      map.on("move", function() {
        let newPoint = map.latLngToLayerPoint(L.latLng(stuffy.lat, stuffy.lng));
        markerDiv.style.left = newPoint.x + "px";
        markerDiv.style.top = newPoint.y + "px";
      });
    }
    
    /***** INTERACTIVE CAPTURE MECHANIC *****/
    function startCapture(stuffy, markerElement) {
      // Display a simple capture overlay with a roll (simulate wheel-of-fortune)
      let roll = Math.floor(Math.random() * 100) + 1;
      let success = roll <= stuffy.rarity.successRate;
      animateWheelRoll(roll, () => {
        if (success) {
          alert(`Success! You captured a ${stuffy.name} (Roll: ${roll})!`);
          capturedStuffies.push(stuffy);
          updateStuffyCollection();
          // Remove markerElement from DOM
          markerElement.parentNode.removeChild(markerElement);
        } else {
          alert(`Capture failed! (Roll: ${roll})`);
        }
      });
    }
    
    function animateWheelRoll(finalRoll, callback) {
      // Simple animation using console logs (replace with UI animation if desired)
      let startTime = Date.now();
      let duration = 2000;
      let interval = setInterval(() => {
        console.log("Rolling: " + (Math.floor(Math.random() * 100) + 1));
        if (Date.now() - startTime >= duration) {
          clearInterval(interval);
          console.log("Final Roll: " + finalRoll);
          callback();
        }
      }, 100);
    }
    
    /***** HOME BASE STORAGE *****/
    function transferToHome() {
      if (capturedStuffies.length === 0) {
        alert("No stuffies to transfer!");
        return;
      }
      let homeStorage = JSON.parse(localStorage.getItem("homeStuffies") || "[]");
      homeStorage.push(...capturedStuffies);
      localStorage.setItem("homeStuffies", JSON.stringify(homeStorage));
      capturedStuffies = [];
      updateStuffyCollection();
      alert("All stuffies have been transferred to your home!");
    }
    
    function updateStuffyCollection() {
      let collectionDiv = document.getElementById("collectionDisplay");
      collectionDiv.innerHTML = "";
      capturedStuffies.forEach(stuffy => {
        let img = document.createElement("img");
        img.src = stuffy.image;
        img.alt = stuffy.name;
        img.className = "stuffy-img";
        collectionDiv.appendChild(img);
      });
    }
    
    /***** INITIALIZATION *****/
    navigator.geolocation.getCurrentPosition(function(position) {
      let lat = position.coords.latitude;
      let lng = position.coords.longitude;
      map.setView([lat, lng], 15);
      playerMarker.setLatLng([lat, lng]);
      interactionCircle.setLatLng([lat, lng]);
      setHomeLocation(lat, lng);
      spawnStuffies(lat, lng);
    }, function(error) {
      console.error("Error getting initial position: " + error.message);
      spawnStuffies(defaultLat, defaultLng);
    });
    
    updateStuffyCollection();
  </script>
</body>
</html>
