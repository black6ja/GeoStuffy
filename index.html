<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoStuffy - Stuffed Animal Capture Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f0f0f0; }
    #map { height: 70vh; width: 100%; }

    /* Stuffies as Images with Rarity Dots */
    .stuffy-marker { position: absolute; transform: translate(-50%, -50%); text-align: center; }
    .stuffy-image { width: 50px; height: 50px; border-radius: 10px; display: block; }

    /* Rarity Indicator */
    .rarity-dot { width: 12px; height: 12px; border-radius: 50%; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); box-shadow: 0 0 4px rgba(0,0,0,0.5); }
    .normal { background-color: gray; }
    .rare { background-color: blue; }
    .epic { background-color: purple; }
    .legendary { background-color: gold; animation: glow 1.5s infinite alternate; }

    @keyframes glow { 0% { box-shadow: 0 0 5px gold; } 100% { box-shadow: 0 0 15px gold; } }

    /* Interaction Circle */
    .interaction-circle { stroke: blue; fill: blue; fill-opacity: 0.2; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button onclick="transferToHome()">Transfer to Home</button>
  <div id="collection"><h2>Your Captured Stuffies</h2><div id="collectionDisplay"></div></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /***** GLOBAL VARIABLES *****/
    let homeLocation = null;
    let capturedStuffies = [];
    let activeStuffies = [];
    const maxStuffies = 40; // Limit active stuffies
    const respawnDelay = 10 * 60 * 1000; // 10-minute respawn delay

    const rarityLevels = {
      normal: { chance: 60, name: "Cuddly Stuffy", color: "normal", successRate: 70 },
      rare: { chance: 25, name: "Mystic Stuffy", color: "rare", successRate: 50 },
      epic: { chance: 10, name: "Ethereal Stuffy", color: "epic", successRate: 30 },
      legendary: { chance: 5, name: "Celestial Stuffy", color: "legendary", successRate: 10 }
    };

    /***** MAP SETUP *****/
    var map = L.map('map').setView([51.505, -0.09], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var playerMarker = L.marker([51.505, -0.09], { icon: L.divIcon({ className: '', html: '<div class="blinking-circle"></div>', iconSize: [10, 10], iconAnchor: [5, 5] })}).addTo(map);
    var interactionRadius = 230;
    var interactionCircle = L.circle(playerMarker.getLatLng(), { radius: interactionRadius, className: 'interaction-circle' }).addTo(map);

    /***** SPAWNING STUFFIES (LIMIT ACTIVE STUFFIES) *****/
    function spawnStuffies(playerLat, playerLng) {
      while (activeStuffies.length < maxStuffies) {
        let rarity = assignRarity();
        let point = randomPointNearRoads(playerLat, playerLng, 5);
        let stuffy = {
          id: `stuffy_${Date.now()}`,
          name: `${rarity.name}`,
          rarity: rarity,
          lat: point.lat,
          lng: point.lng,
          image: `Subject${(Math.floor(Math.random() * 50) + 1)}.png`
        };
        createStuffyMarker(stuffy);
        activeStuffies.push(stuffy);
      }
    }

    function assignRarity() {
      let roll = Math.random() * 100;
      let cumulative = 0;
      for (let key in rarityLevels) {
        cumulative += rarityLevels[key].chance;
        if (roll <= cumulative) return rarityLevels[key];
      }
      return rarityLevels.normal;
    }

    function randomPointNearRoads(lat, lng, radiusMiles) {
      let degreesPerMile = 1 / 69;
      let r = radiusMiles * degreesPerMile * Math.sqrt(Math.random());
      let theta = Math.random() * 2 * Math.PI;
      return { lat: lat + r * Math.cos(theta), lng: lng + r * Math.sin(theta) };
    }

    function createStuffyMarker(stuffy) {
      let marker = L.marker([stuffy.lat, stuffy.lng], {
        icon: L.divIcon({
          className: 'stuffy-marker',
          html: `<div class="rarity-dot ${stuffy.rarity.color}"></div><img src="${stuffy.image}" class="stuffy-image">`,
          iconSize: [50, 50],
          iconAnchor: [25, 25]
        })
      }).addTo(map);
      marker.on('click', () => startCapture(stuffy, marker));
    }

    /***** CAPTURE LOGIC & 10-MIN RESPAWN TIMER *****/
    function startCapture(stuffy, marker) {
      let roll = Math.floor(Math.random() * 100) + 1;
      if (roll <= stuffy.rarity.successRate) {
        alert(`You captured ${stuffy.name}!`);
        capturedStuffies.push(stuffy);
        updateStuffyCollection();
        map.removeLayer(marker);
        activeStuffies = activeStuffies.filter(s => s.id !== stuffy.id);
        setTimeout(() => spawnStuffies(playerMarker.getLatLng().lat, playerMarker.getLatLng().lng), respawnDelay);
      } else {
        alert(`Capture failed!`);
      }
    }

    /***** HOME BASE STORAGE *****/
    function transferToHome() {
      if (capturedStuffies.length === 0) {
        alert("No stuffies to transfer!");
        return;
      }
      let homeStorage = JSON.parse(localStorage.getItem("homeStuffies") || "[]");
      homeStorage.push(...capturedStuffies);
      localStorage.setItem("homeStuffies", JSON.stringify(homeStorage));
      capturedStuffies = [];
      updateStuffyCollection();
      alert("All stuffies have been transferred to your home!");
    }

    function updateStuffyCollection() {
      let collectionDiv = document.getElementById("collectionDisplay");
      collectionDiv.innerHTML = capturedStuffies.map(stuffy => `<img src="${stuffy.image}" class="stuffy-img">`).join('');
    }

    navigator.geolocation.getCurrentPosition(position => {
      let lat = position.coords.latitude;
      let lng = position.coords.longitude;
      map.setView([lat, lng], 15);
      playerMarker.setLatLng([lat, lng]);
      interactionCircle.setLatLng([lat, lng]);
      spawnStuffies(lat, lng);
    });
  </script>
</body>
</html>
